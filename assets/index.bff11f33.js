import{c as z,P,r as l,a as c,j as s,_ as H,U as k,F as j,b as x,I as v}from"./index.04a4b329.js";import{M as O}from"./event-util.6fcdd9df.js";import{F as _,I as V}from"./input.a741688f.js";import{P as q,a as A,C as N}from"./ClickableDescription.c845ef45.js";import{E as G,F as K,b as L,a as Q}from"./FooterRestart.3459ca14.js";import{F as R}from"./FooterUndo.f5ae4039.js";const F="SIT.history",T=()=>{try{const e=P.get(F);return JSON.parse(e)}catch{return[]}},B=()=>T()[0]||[],[D,S]=z({gameState:B()}),W=e=>{const t=T();t.unshift(e),t.length>10&&t.pop(),P.set(F,JSON.stringify(t))},M=e=>{typeof e=="function"?S.set(({gameState:t})=>({gameState:e(t)})):S.set({gameState:e}),W(S.get().gameState)},X=()=>p.set([]),Y=()=>{const e=T();e.length>1&&e.shift(),P.set(F,JSON.stringify(e)),S.set({gameState:e[0]})},Z=e=>e.map(t=>({...t,total:0,points:t.points.map(()=>({}))})),$=()=>M(e=>{const t=Z(e);return[...t.slice(1),t[0]]}),p={set:M,get:B,undo:Y,reset:X,rearrange:$},ee=(e,t,r)=>({player:e,points:k.array(r).map(()=>({})),total:0}),te=e=>{const t=Math.floor(e.numberOfCards/e.numberOfPlayers);return A.get().players.slice(0,e.numberOfPlayers).map((r,a)=>ee(r,a,t))},se=e=>p.set(te(e)),re={numberOfCards:{onChange:e=>{const t=Number(e);return isNaN(t)||t<32?{id:"SIT.startup.cartCount.invalid"}:void 0}},numberOfPlayers:{onChange:e=>{const t=Number(e);if(isNaN(t)||t<2||t>10)return{id:"players.count.invalid",values:{min:2,max:10}};if(t>A.get().players.length)return{id:"players.count.exceedsRegistered"}}}},ne=({numberOfCards:e,numberOfPlayers:t})=>{se({numberOfCards:+e,numberOfPlayers:+t})},ae={numberOfCards:"52",numberOfPlayers:""},oe=()=>{const[e,t]=l.exports.useState(O.initialData(ae)),{fields:r,Form:a}=O.useForm();return c("div",{className:"spade-is-trump",children:[s("div",{className:"configs",children:c(a,{className:"startup",onSubmit:ne,validation:re,data:e,onChange:t,children:[s(_,{field:r.numberOfCards,label:"SIT.startup.cardCount",type:"number"}),s(_,{field:r.numberOfPlayers,label:"players.count",type:"number"}),s("button",{type:"submit",children:H("APP.start")})]})}),s(q,{})]})},I=e=>{if(e&&e.trim()){const t=Number(e.trim());if(!isNaN(t)&&t>=0)return t}},E=e=>e!==void 0?String(e):"",ie=({points:e,activeRound:t,limit:r,onChange:a,checkable:o,active:n})=>{const[i,f]=l.exports.useState(!1),[m,h]=l.exports.useState(()=>E(e.tip)),b=l.exports.useCallback(()=>{t&&f(!0)},[t]),g=l.exports.useCallback(u=>{if(t){const d=I(u);d===void 0?h(""):d>=0&&d<=r&&h(u)}},[t,r]),C=l.exports.useCallback(u=>{if(t){const d=I(u);d!==void 0&&a({...e,tip:d}),f(!1)}},[t,e,a]),w=l.exports.useCallback(u=>{u.preventDefault(),C(m)},[C,m]),y=l.exports.useCallback(u=>{!t||e.earned||a({...e,earned:u})},[t,e,a]),J=l.exports.useCallback(()=>{y(Number(e.tip)+10)},[y,e]),U=l.exports.useCallback(()=>{y(Number(e.tip)*-1)},[y,e]);if(l.exports.useEffect(()=>{h(E(e.tip))},[e.tip]),e.earned!==void 0)return e.earned>0?s("td",{className:"points points-earned",children:e.earned}):s("td",{className:"points points-lost",children:e.earned});if(!i){const u=t&&n?"points active":"points",d=t&&o;return c("td",{onClick:d?void 0:b,className:u,children:[s("div",{onClick:d?b:void 0,className:"points-tip",children:m}),d&&c(j,{children:[s("button",{className:"points-success",type:"button",onClick:J,children:"+"}),s("button",{className:"points-failed",type:"button",onClick:U,children:"-"})]})]})}return s("td",{children:s("form",{onSubmit:w,children:s(V,{className:"points-input",value:m,autoFocus:!0,onChange:g,onBlur:C,type:"number"})})})},ce=(e,t)=>{const r=k.array(t).map(()=>0);for(let o=0;o<e.length;o++){const n=e[o].points;for(let i=0;i<n.length;i++)n[i].earned!==void 0&&r[i]++}const a=r.findIndex(o=>o<e.length);return a===-1?void 0:a},le=(e,t)=>{if(t===void 0)return!0;for(let r=0;r<e.length;r++)if(e[r].points[t].tip===void 0)return!1;return!0},ue=(e,t,r)=>{const a=e.map(n=>n.points.map(i=>i.earned).filter((i,f)=>f===t)[0]);if(a.filter(n=>n===void 0).length)return!1;const o=a.map(n=>n>10?n-10:void 0).reduce((n,i=0)=>n+i,0);return Boolean(o>r||o===r&&a.filter(n=>n===0).length)},de=(e,t)=>p.set(r=>{const a=[...r];return a[t]=e,a}),me=(e,t,r)=>a=>{const o=[...e.points];o[r]=a,de({...e,points:o},t)},pe=()=>{const{gameState:e}=D(({gameState:o})=>({gameState:o})),t=e[0].points.length,r=ce(e,t),a=e.map(o=>o.points.reduce((n,i)=>n+(i.earned||0),0));return c("table",{children:[s("thead",{children:c("tr",{children:[s(N,{desc:x("SIT.cardCount"),short:"#",tag:"th",className:"card-number"}),e.map(({player:{name:o,shortcut:n}},i)=>s(N,{desc:o,short:n,tag:"th"},i))]})}),c("tbody",{children:[k.array(t).map((o,n)=>{const i=r===n,f=le(e,r),m=t-n,h=ue(e,n,m);return c("tr",{className:r!==void 0&&n>r?"disabled":void 0,children:[c("td",{children:[m,h&&s("span",{className:"error-round",children:s(v.Alert,{})})]}),e.map((b,g)=>s(ie,{points:b.points[n],limit:m,checkable:f,onChange:me(b,g,n),active:n%e.length===g,activeRound:i},g))]},m)}),c("tr",{className:"sum",children:[s(N,{desc:x("SIT.points"),short:"\u2211",tag:"td"}),a.map((o,n)=>c("td",{children:[o,r===void 0&&o===Math.max(...a)&&s(v.Crown,{className:"winner"})]},n))]})]})]})},fe=({started:e})=>c(K,{children:[s(R,{onClick:p.undo}),e&&s(L,{onClick:p.reset}),e&&s(Q,{onClick:p.rearrange,description:"SIT.reorder",children:s(v.Refresh,{})})]}),Ne=()=>{const e=D(({gameState:t})=>!!t.length);return s(G,{fix:p.reset,children:c(j,{children:[s("div",{className:"spade-is-trump",children:e?s(pe,{}):s(oe,{})}),s(fe,{started:e})]})})};export{Ne as default};
