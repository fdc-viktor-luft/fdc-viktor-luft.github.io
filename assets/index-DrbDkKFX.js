import{c as G,P as I,U as x,j as t,x as o,r as M,v as K}from"./index-VnnWUwzb.js";import{E as H,F as k,b as B}from"./FooterRestart-WM3EyTOt.js";import{F as D}from"./FooterUndo-yRoqo1TH.js";import{a as P,C as f,P as R}from"./PlayerSelection-DWjhOEfK.js";import{a as m}from"./Cube-Cnmvxxbg.js";import{M as p}from"./DisplayError-B-QuU1PC.js";import{F as T}from"./input-M9Vg70J2.js";var l=(s=>(s.M1="M1",s.M2="M2",s.M3="M3",s.M4="M4",s.M5="M5",s.M6="M6",s.TRIPLE="TRIPLE",s.FOURSOME="FOURSOME",s.FULL_HOUSE="FULL_HOUSE",s.SMALL_STREET="SMALL_STREET",s.BIG_STREET="BIG_STREET",s.SENSATION="SENSATION",s.CHANCE="CHANCE",s))(l||{});const F={M1:{multiplier:1},M2:{multiplier:2},M3:{multiplier:3},M4:{multiplier:4},M5:{multiplier:5},M6:{multiplier:6},TRIPLE:{},FOURSOME:{},FULL_HOUSE:{fixedValue:25},SMALL_STREET:{fixedValue:30},BIG_STREET:{fixedValue:40},SENSATION:{fixedValue:50},CHANCE:{}},g={players:[]},C="gimmick",N=()=>{try{const s=I.get(C);return JSON.parse(s)}catch{return[]}},W=()=>N()[0]||g,[y,S]=G(W()),b=s=>{S.set(s);const e=S.get(),n=N();n.unshift(e),n.length>20&&n.pop(),I.set(C,JSON.stringify(n))},J=()=>{b(g)},$=()=>{const s=N();if(s.length>1){s.shift(),I.set(C,JSON.stringify(s));const e=s[0];S.set(e)}},q=s=>({...s,points:{}}),z=s=>{const e=P.get().players.slice(0,s).map(q);b({players:e})},L=s=>{const e=Math.min(...s.map(({points:n})=>Object.keys(n).length));return s.find(({points:n})=>Object.keys(n).length===e)},Q=s=>b(({players:e})=>{const n=[...e],r=n.findIndex(({uuid:a})=>a===s.uuid);return n[r]=s,{players:n}}),X=(s,e)=>{const{multiplier:n}=F[e],r=n?n*s:s,a=L(S.get().players);a.points[e]=r,Q(a)},_=(s,e)=>e.every(n=>s[n]!==void 0),Y=s=>_(s,Object.values(l).slice(0,6)),Z=s=>_(s,Object.values(l)),w=s=>s.every(e=>Z(e.points)),A=s=>x.sum(s.M1,s.M2,s.M3,s.M4,s.M5,s.M6)>=63?35:0,V=({points:s})=>x.sum(...Object.values(s))+A(s),ss=s=>{var r;const e=s.map(a=>({player:a,sum:V(a)})),n=Math.max(...e.map(({sum:a})=>a));return(r=e.find(({sum:a})=>a===n))==null?void 0:r.player},c={restart:J,undo:$,selectPlayers:z,selectValue:X,getCurrentActivePlayer:L,calculateSum:V,calculateBonus:A,finishedMultiplier:Y,allFinished:w,playerWithMostPoints:ss},ts={[l.M1]:t.jsx(m,{count:1}),[l.M2]:t.jsx(m,{count:2}),[l.M3]:t.jsx(m,{count:3}),[l.M4]:t.jsx(m,{count:4}),[l.M5]:t.jsx(m,{count:5}),[l.M6]:t.jsx(m,{count:6}),[l.TRIPLE]:o("GIMMICK.triple"),[l.FOURSOME]:o("GIMMICK.foursome"),[l.FULL_HOUSE]:o("GIMMICK.fullHouse"),[l.SMALL_STREET]:o("GIMMICK.smallStreet"),[l.BIG_STREET]:o("GIMMICK.bigStreet"),[l.SENSATION]:o("GIMMICK.sensation"),[l.CHANCE]:o("GIMMICK.chance")},v=({row:s,players:e,activePlayer:n,onClick:r})=>t.jsxs("tr",{children:[t.jsx("td",{className:"first",children:ts[s]}),e.map(({points:a,uuid:u})=>t.jsx("td",{className:x.classNames(n.uuid===u||"inactive"),onClick:a[s]===void 0&&n.uuid===u?()=>r(s):void 0,children:a[s]===0?"✘":a[s]},u))]}),es={num:{onSubmit:s=>{const e=Number(s);if(isNaN(e)||e<5||e>30)return{id:"GIMMICK.value.invalid",values:{min:5,max:30}}}}},ns={num:""},E=({value:s,gimmickRow:e,close:n})=>{const[r,a]=M.useState(p.initialData(ns)),{fields:u,Form:h}=p.useForm(),d=M.useCallback(()=>{c.selectValue(s,e),n()},[s,e,n]),i=M.useCallback(({num:j})=>{c.selectValue(+j,e),n()},[e,n]);return t.jsx("div",{className:x.classNames("value",s===-1&&"no-hover"),onClick:s===-1?void 0:d,children:s===-1?t.jsx(h,{onSubmit:i,validation:es,data:r,onChange:a,children:t.jsx(T,{field:u.num,type:"number",autoFocus:!0})}):s===0?"✘":s>10?"✓":s})},as=({gimmickRow:s,close:e})=>{const{multiplier:n,fixedValue:r}=F[s];return t.jsxs("div",{className:"select-overlay",children:[t.jsx("div",{className:"select-overlay-inner",children:n?[0,1,2,3,4,5].map(a=>t.jsx(E,{gimmickRow:s,value:a,close:e},a)):r?[0,r].map(a=>t.jsx(E,{gimmickRow:s,value:a,close:e},a)):[0,-1].map(a=>t.jsx(E,{gimmickRow:s,value:a,close:e},a))}),t.jsx("div",{className:"select-overlay-outer",onClick:e})]})},rs=()=>{const[s,e]=M.useState(),n=M.useCallback(()=>e(void 0),[]),r=y(({players:i})=>i),a=c.getCurrentActivePlayer(r),u=Object.values(l).slice(0,6),h=Object.values(l).slice(6),d=y(({players:i})=>c.allFinished(i)?c.playerWithMostPoints(i):void 0);return t.jsxs(t.Fragment,{children:[t.jsxs("table",{children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{className:"first"}),r.map(({name:i,shortcut:j,uuid:O},U)=>t.jsx(f,{desc:i,short:t.jsx("span",{children:j}),tag:"th",className:x.classNames(!d&&a.uuid===O&&"active",(d==null?void 0:d.uuid)===O&&"winner")},U))]})}),t.jsxs("tbody",{children:[u.map(i=>t.jsx(v,{row:i,players:r,onClick:e,activePlayer:a},i)),t.jsxs("tr",{children:[t.jsx(f,{desc:o("GIMMICK.bonus"),short:"🎁",tag:"td"}),r.map(i=>t.jsx("td",{children:c.finishedMultiplier(i.points)?c.calculateBonus(i.points)||"✘":""},i.uuid))]}),h.map(i=>t.jsx(v,{row:i,players:r,onClick:e,activePlayer:a},i)),t.jsxs("tr",{children:[t.jsx(f,{desc:o("GIMMICK.sum"),short:"∑",tag:"td"}),r.map(i=>t.jsx("td",{children:c.calculateSum(i)},i.uuid))]})]})]}),s&&t.jsx(as,{gimmickRow:s,close:n})]})},is={numberOfPlayers:{onChange:s=>{const e=Number(s);if(isNaN(e)||e<1||e>10)return{id:"players.count.invalid",values:{min:1,max:10}};if(e>P.get().players.length)return{id:"players.count.exceedsRegistered"}}}},ls=({numberOfPlayers:s})=>{c.selectPlayers(+s)},cs={numberOfPlayers:""},os=()=>{const[s,e]=M.useState(p.initialData(cs)),{fields:n,Form:r}=p.useForm();return t.jsxs("div",{className:"spade-is-trump",children:[t.jsx("div",{className:"configs",children:t.jsxs(r,{className:"startup",onSubmit:ls,validation:is,data:s,onChange:e,children:[t.jsx(T,{field:n.numberOfPlayers,label:"players.count",type:"number"}),t.jsx("button",{type:"submit",children:K("APP.start")})]})}),t.jsx(R,{})]})},us=({started:s})=>t.jsxs(k,{children:[t.jsx(D,{onClick:c.undo}),s&&t.jsx(B,{onClick:c.restart})]}),js=()=>{const s=y(({players:e})=>!!e.length);return t.jsx(H,{fix:c.restart,children:t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"gimmick",children:s?t.jsx(rs,{}):t.jsx(os,{})}),t.jsx(us,{started:s})]})})};export{js as default};
