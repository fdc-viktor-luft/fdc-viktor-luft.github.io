import{c as J,P as C,r as c,j as e,x as k,U as N,I as S,v as U}from"./index-C5d-M75W.js";import{E as z,F as H,b as V,a as R}from"./FooterRestart-DWUh72Zz.js";import{F as q}from"./FooterUndo-C2bEwUJe.js";import{C as y,P as G,a as E}from"./PlayerSelection-h94U9UtM.js";import{I as K,F}from"./input-paecsdXs.js";import{M as T}from"./DisplayError-Bw3wIOAX.js";const v="SIT.history",P=()=>{try{const s=C.get(v);return JSON.parse(s)}catch{return[]}},_=()=>P()[0]||[],[A,b]=J({gameState:_()}),L=s=>{const t=P();t.unshift(s),t.length>10&&t.pop(),C.set(v,JSON.stringify(t))},B=s=>{typeof s=="function"?b.set(({gameState:t})=>({gameState:s(t)})):b.set({gameState:s}),L(b.get().gameState)},Q=()=>m.set([]),W=()=>{const s=P();s.length>1&&s.shift(),C.set(v,JSON.stringify(s)),b.set({gameState:s[0]})},X=s=>s.map(t=>({...t,total:0,points:t.points.map(()=>({}))})),Y=()=>B(s=>{const t=X(s);return[...t.slice(1),t[0]]}),m={set:B,get:_,undo:W,reset:Q,rearrange:Y},O=s=>{if(s&&s.trim()){const t=Number(s.trim());if(!isNaN(t)&&t>=0)return t}},I=s=>s!==void 0?String(s):"",Z=({points:s,activeRound:t,limit:r,onChange:a,checkable:o,active:n})=>{const[i,p]=c.useState(!1),[d,f]=c.useState(()=>I(s.tip)),h=c.useCallback(()=>{t&&p(!0)},[t]),x=c.useCallback(l=>{if(t){const u=O(l);u===void 0?f(""):u>=0&&u<=r&&f(l)}},[t,r]),g=c.useCallback(l=>{if(t){const u=O(l);u!==void 0&&a({...s,tip:u}),p(!1)}},[t,s,a]),D=c.useCallback(l=>{l.preventDefault(),g(d)},[g,d]),j=c.useCallback(l=>{!t||s.earned||a({...s,earned:l})},[t,s,a]),M=c.useCallback(()=>{j(Number(s.tip)+10)},[j,s]),w=c.useCallback(()=>{j(Number(s.tip)*-1)},[j,s]);if(c.useEffect(()=>{f(I(s.tip))},[s.tip]),s.earned!==void 0)return s.earned>0?e.jsx("td",{className:"points points-earned",children:s.earned}):e.jsx("td",{className:"points points-lost",children:s.earned});if(!i){const l=t&&n?"points active":"points",u=t&&o;return e.jsxs("td",{onClick:u?void 0:h,className:l,children:[e.jsx("div",{onClick:u?h:void 0,className:"points-tip",children:d}),u&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"points-success",type:"button",onClick:M,children:"+"}),e.jsx("button",{className:"points-failed",type:"button",onClick:w,children:"-"})]})]})}return e.jsx("td",{children:e.jsx("form",{onSubmit:D,children:e.jsx(K,{className:"points-input",value:d,autoFocus:!0,onChange:x,onBlur:g,type:"number"})})})},$=(s,t)=>{const r=N.array(t).map(()=>0);for(let o=0;o<s.length;o++){const n=s[o].points;for(let i=0;i<n.length;i++)n[i].earned!==void 0&&r[i]++}const a=r.findIndex(o=>o<s.length);return a===-1?void 0:a},ss=(s,t)=>{if(t===void 0)return!0;for(let r=0;r<s.length;r++)if(s[r].points[t].tip===void 0)return!1;return!0},ts=(s,t,r)=>{const a=s.map(n=>n.points.map(i=>i.earned).filter((i,p)=>p===t)[0]);if(a.filter(n=>n===void 0).length)return!1;const o=a.map(n=>n>10?n-10:void 0).reduce((n,i=0)=>n+i,0);return!!(o>r||o===r&&a.filter(n=>n===0).length)},es=(s,t)=>m.set(r=>{const a=[...r];return a[t]=s,a}),rs=(s,t,r)=>a=>{const o=[...s.points];o[r]=a,es({...s,points:o},t)},ns=()=>{const{gameState:s}=A(({gameState:o})=>({gameState:o})),t=s[0].points.length,r=$(s,t),a=s.map(o=>o.points.reduce((n,i)=>n+(i.earned||0),0));return e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx(y,{desc:k("SIT.cardCount"),short:"#",tag:"th",className:"card-number"}),s.map(({player:{name:o,shortcut:n}},i)=>e.jsx(y,{desc:o,short:n,tag:"th"},i))]})}),e.jsxs("tbody",{children:[N.array(t).map((o,n)=>{const i=r===n,p=ss(s,r),d=t-n,f=ts(s,n,d);return e.jsxs("tr",{className:r!==void 0&&n>r?"disabled":void 0,children:[e.jsxs("td",{children:[d,f&&e.jsx("span",{className:"error-round",children:e.jsx(S.Alert,{})})]}),s.map((h,x)=>e.jsx(Z,{points:h.points[n],limit:d,checkable:p,onChange:rs(h,x,n),active:n%s.length===x,activeRound:i},x))]},d)}),e.jsxs("tr",{className:"sum",children:[e.jsx(y,{desc:k("SIT.points"),short:"âˆ‘",tag:"td"}),a.map((o,n)=>e.jsxs("td",{children:[o,r===void 0&&o===Math.max(...a)&&e.jsx(S.Crown,{className:"winner"})]},n))]})]})]})},as=(s,t,r)=>({player:s,points:N.array(r).map(()=>({})),total:0}),os=s=>{const t=Math.floor(s.numberOfCards/s.numberOfPlayers);return E.get().players.slice(0,s.numberOfPlayers).map((r,a)=>as(r,a,t))},is=s=>m.set(os(s)),cs={numberOfCards:{onChange:s=>{const t=Number(s);return isNaN(t)||t<32?{id:"SIT.startup.cartCount.invalid"}:void 0}},numberOfPlayers:{onChange:s=>{const t=Number(s);if(isNaN(t)||t<2||t>10)return{id:"players.count.invalid",values:{min:2,max:10}};if(t>E.get().players.length)return{id:"players.count.exceedsRegistered"}}}},ls=({numberOfCards:s,numberOfPlayers:t})=>{is({numberOfCards:+s,numberOfPlayers:+t})},us={numberOfCards:"52",numberOfPlayers:""},ds=()=>{const[s,t]=c.useState(T.initialData(us)),{fields:r,Form:a}=T.useForm();return e.jsxs("div",{className:"spade-is-trump",children:[e.jsx("div",{className:"configs",children:e.jsxs(a,{className:"startup",onSubmit:ls,validation:cs,data:s,onChange:t,children:[e.jsx(F,{field:r.numberOfCards,label:"SIT.startup.cardCount",type:"number"}),e.jsx(F,{field:r.numberOfPlayers,label:"players.count",type:"number"}),e.jsx("button",{type:"submit",children:U("APP.start")})]})}),e.jsx(G,{})]})},ms=({started:s})=>e.jsxs(H,{children:[e.jsx(q,{onClick:m.undo}),s&&e.jsx(V,{onClick:m.reset}),s&&e.jsx(R,{onClick:m.rearrange,description:"SIT.reorder",children:e.jsx(S.Refresh,{})})]}),gs=()=>{const s=A(({gameState:t})=>!!t.length);return e.jsx(z,{fix:m.reset,children:e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"spade-is-trump",children:s?e.jsx(ns,{}):e.jsx(ds,{})}),e.jsx(ms,{started:s})]})})};export{gs as default};
